---
# Test infrastructure compose file
# This file defines services for running tests that need container operations
# Using compose handles path translation automatically, enabling tests to run
# from within a devcontainer (DooD - Docker-out-of-Docker)
# Note: 'version' field is deprecated in docker-compose 1.27.0+

services:
  # Service to initialize a test workspace using init-workspace.sh
  init-workspace:
    image: ${TEST_IMAGE:-ghcr.io/vig-os/devcontainer:dev}
    volumes:
      - test-workspace:/workspace
    # Note: TTY is allocated by 'podman compose run -it', not here
    command: /root/assets/init-workspace.sh

  # Service to inspect the initialized workspace (for debugging)
  workspace-inspector:
    image: ${TEST_IMAGE:-ghcr.io/vig-os/devcontainer:dev}
    volumes:
      - test-workspace:/workspace
    command: ls -la /workspace
    profiles:
      - debug

  # Test sidecar service
  test-sidecar:
    image: localhost/test-sidecar:latest
    container_name: test-sidecar
    volumes:
      - test-workspace:/workspace
    command: sleep infinity

volumes:
  # Named volume for test workspace - compose manages this, no host path needed
  test-workspace:
    name: ${VOLUME_NAME:-devcontainer-test-workspace}
