---
type: pull_request
state: open
branch: feature/170-bootstrap-smoke-test-repo → dev
created: 2026-02-26T12:09:36Z
updated: 2026-02-26T12:26:56Z
author: c-vigo
author_url: https://github.com/c-vigo
url: https://github.com/vig-os/devcontainer/pull/210
comments: 3
labels: none
assignees: c-vigo
milestone: none
projects: none
relationship: none
synced: 2026-02-27T04:19:09.913Z
---

# [PR 210](https://github.com/vig-os/devcontainer/pull/210) feat: bootstrap smoke-test repo with bare-runner CI

## Description

Bootstraps the smoke-test infrastructure for issue #170. This PR delivers the devcontainer-side changes required to allow a downstream workspace (bootstrapped from the template) to run `ci.yml` successfully on a bare GitHub-hosted runner — without a devcontainer being present.

The changes harden the image and workspace template so that tools like `pre-commit` and `bandit` are available in both devcontainer and bare-runner contexts, move runtime environment variables into the image, and wire `just sync` into the workspace bootstrap so the project package is installed from the start.

## Type of Change

- [x] `feat` -- New feature
- [ ] `fix` -- Bug fix
- [ ] `docs` -- Documentation only
- [ ] `chore` -- Maintenance task (deps, config, etc.)
- [ ] `refactor` -- Code restructuring (no behavior change)
- [ ] `test` -- Adding or updating tests
- [ ] `ci` -- CI/CD pipeline changes
- [ ] `build` -- Build system or dependency changes
- [ ] `revert` -- Reverts a previous commit
- [ ] `style` -- Code style (formatting, whitespace)

### Modifiers

- [ ] Breaking change (`!`) -- This change breaks backward compatibility

## Changes Made

- `Containerfile` — add `bandit[toml]` to system Python install; bake `PRE_COMMIT_HOME`, `UV_PROJECT_ENVIRONMENT`, and `VIRTUAL_ENV` as `ENV` so they are available outside the devcontainer context
- `assets/workspace/.github/actions/setup-env/action.yml` — add mandatory `pre-commit install` step
- `assets/workspace/.devcontainer/scripts/setup-gh-repo.sh` — detach org default code security configuration on post-create
- `assets/workspace/.devcontainer/justfile.base` / `justfile.base` — `sync` recipe no longer passes `--no-install-project`; `update` target calls `sync`
- `assets/init-workspace.sh` — run `just sync` after placeholder replacement so the project package is installed during bootstrap
- `assets/workspace/.devcontainer/docker-compose.yml` — remove env vars now baked into image
- `tests/test_integration.py` — new/updated integration tests covering all of the above
- `tests/bats/setup-gh-repo.bats` — BATS tests for security-config detach
- `CHANGELOG.md` — Unreleased entries added

## Changelog Entry

### Added

- **Smoke-test repo bootstrap validation** ([#170](https://github.com/vig-os/devcontainer/issues/170))
  - Downstream smoke coverage that bootstraps a workspace from the template and verifies `ci.yml` passes on a real GitHub-hosted runner
- **`bandit` pre-installed in devcontainer image** ([#170](https://github.com/vig-os/devcontainer/issues/170))
  - `bandit[toml]` added to the system Python install in the Containerfile
- **`pre-commit` pre-installed in CI `setup-env` action** ([#170](https://github.com/vig-os/devcontainer/issues/170))
  - Workspace `setup-env` composite action now installs `pre-commit` as a mandatory step so hooks are available in bare-runner CI without a devcontainer
- **`setup-gh-repo.sh` detaches org default code security configuration** ([#170](https://github.com/vig-os/devcontainer/issues/170))
  - On post-create, detach any org-level default security config from the repo to avoid conflicts with the security workflows shipped in the workspace template
  - Graceful fallback when repo ID cannot be resolved or permissions are insufficient
- **`init-workspace.sh` runs `just sync` after placeholder replacement** ([#170](https://github.com/vig-os/devcontainer/issues/170))
  - Resolves the `uv.lock` for the new project name and installs the project package into the venv during workspace bootstrap

### Changed

- **Environment variables moved from `docker-compose.yml` into Containerfile `ENV`** ([#170](https://github.com/vig-os/devcontainer/issues/170))
  - `PRE_COMMIT_HOME`, `UV_PROJECT_ENVIRONMENT`, and `VIRTUAL_ENV` are now baked into the image so they are available outside of the devcontainer context (e.g. bare-runner CI)
- **`just sync` installs the project package** ([#170](https://github.com/vig-os/devcontainer/issues/170))
  - Removed `--no-install-project` from the `sync` recipe so the workspace project is always installed into the venv

## Testing

- [x] Tests pass locally (`just test`)
- [ ] Manual testing performed (describe below)

### Manual Testing Details

N/A

## Checklist

- [x] My code follows the project's style guidelines
- [x] I have performed a self-review of my code
- [ ] I have commented my code, particularly in hard-to-understand areas
- [x] I have updated the documentation accordingly (edit `docs/templates/`, then run `just docs`)
- [x] I have updated `CHANGELOG.md` in the `[Unreleased]` section (and pasted the entry above)
- [x] My changes generate no new warnings or errors
- [x] I have added tests that prove my fix is effective or that my feature works
- [x] New and existing unit tests pass locally with my changes
- [ ] Any dependent changes have been merged and published

## Additional Notes

N/A

Refs: #161, #170, #186



---
---

## Comments (1)

### [Comment #1](https://github.com/vig-os/devcontainer/pull/210#issuecomment-3966270423) by [@c-vigo](https://github.com/c-vigo)

_Posted on February 26, 2026 at 12:20 PM_

@gerchowl this PR temporarily disables all local pre-commit hooks in the shipped container with `manifest.toml`:
```toml
[[entries]]
src = ".pre-commit-config.yaml"
transforms = [
  { type = "RemovePrecommitHooks", hook_ids = [
    "hadolint-docker",
    "generate-docs",
    "sync-manifest",
    "pip-licenses",
    "check-action-pins",
    "bandit",
    "check-skill-names",
    "prepare-commit-msg-strip-trailers",
    "check-agent-identity",
    "validate-commit-msg",
  ] },
...
]
```


This is necessary to run CI in the smoke-test repo, will be fixed with #171. If that's fine, approve & merge.

---
---

## Review Threads (1)

### Review by [@Copilot](https://github.com/apps/copilot-pull-request-reviewer)

_Posted on February 26, 2026 at 12:20 PM_

_File: [`.pre-commit-config.yaml (line 102 RIGHT)`](https://github.com/vig-os/devcontainer/pull/210#discussion_r2858718140)_

```diff
@@ -88,11 +88,20 @@ repos:
     hooks:
       - id: generate-docs
         name: generate-docs (regenerate from templates)
-        entry: bash -c 'uv run python docs/generate.py && git add README.md CONTRIBUTE.md TESTING.md 2>/dev/null || true'
+        entry: uv run python docs/generate.py
         language: system
         files: ^(docs/templates/.*\.j2|docs/narrative/.*\.md|scripts/requirements\.yaml|justfile)$
         pass_filenames: false
 
+  # Workspace sync (keep assets/workspace in sync with manifest)
+  - repo: local
+    hooks:
+      - id: sync-manifest
+        name: sync-manifest
+        entry: uv run python scripts/sync_manifest.py sync assets/workspace/
+        language: system
```

The new `sync-manifest` hook has no `files:`/`types:` filter, so it will run on every commit and can unexpectedly rewrite `assets/workspace/` even for unrelated changes. Consider restricting it to changes that affect the workspace sync inputs (e.g., `scripts/manifest.toml`, `scripts/transforms.py`, or files under the synced sources), or moving it behind a manual `just` target instead of a default pre-commit hook.
```suggestion
        language: system
        files: ^(scripts/manifest\.toml|scripts/transforms\.py)$
```

Conversation:

- **[@c-vigo](https://github.com/c-vigo)** on February 26, 2026 at 12:22 PM — [link](https://github.com/vig-os/devcontainer/pull/210#discussion_r2858727359)

  The design is as intended

---

