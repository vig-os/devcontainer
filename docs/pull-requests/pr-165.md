---
type: pull_request
state: open
branch: bugfix/154-worktree-start-silent-fail-agent-print-hang → dev
created: 2026-02-23T23:17:15Z
updated: 2026-02-23T23:17:16Z
author: gerchowl
author_url: https://github.com/gerchowl
url: https://github.com/vig-os/devcontainer/pull/165
comments: 0
labels: none
assignees: gerchowl
milestone: none
projects: none
relationship: none
synced: 2026-02-24T04:24:15.547Z
---

# [PR 165](https://github.com/vig-os/devcontainer/pull/165) fix(worktree): add agent timeout and gh preflight to worktree-start (#154)

## Description

Fixes two preflight gaps in `just worktree-start` that cause silent or confusing failures:

1. **agent --print hang**: When no linked branch exists, the recipe uses `agent --print` to derive a branch name. In headless mode this can hang indefinitely. The script now wraps the call in a 30s timeout and prints a clear error with manual workaround when it fails.

2. **gh repo set-default ambiguity**: When multiple remotes exist (e.g. origin + fork), `gh` cannot auto-detect the target repo. The recipe now checks for a default repo before any `gh` API calls, auto-resolves from `origin` when possible, or fails with clear instructions.

## Type of Change

- [x] `feat` -- New feature
- [x] `fix` -- Bug fix
- [ ] `docs` -- Documentation only
- [ ] `chore` -- Maintenance task (deps, config, etc.)
- [ ] `refactor` -- Code restructuring (no behavior change)
- [ ] `test` -- Adding or updating tests
- [ ] `ci` -- CI/CD pipeline changes
- [ ] `build` -- Build system or dependency changes
- [ ] `revert` -- Reverts a previous commit
- [ ] `style` -- Code style (formatting, whitespace)

### Modifiers

- [ ] Breaking change (`!`) -- This change breaks backward compatibility

## Changes Made

- **scripts/derive-branch-summary.sh** (new): Extracts agent-based branch summary derivation with timeout and `BRANCH_SUMMARY_CMD` mock for tests
- **justfile.worktree**: Adds gh repo set-default preflight; replaces inline agent call with derive-branch-summary.sh
- **assets/workspace/.devcontainer/justfile.worktree**: Synced from manifest
- **tests/bats/worktree.bats**: Three new tests for derive-branch-summary (success, timeout, error message)
- **CHANGELOG.md**: Entry under Fixed

## Changelog Entry

### Fixed

- **worktree-start preflight gaps — agent hang and gh repo set-default** ([#154](https://github.com/vig-os/devcontainer/issues/154))
  - Add timeout (30s) to agent-based branch summary derivation; failure produces clear error with manual workaround
  - Add gh repo set-default preflight before any gh API calls; auto-resolve from origin or fail with instructions
  - Extract derive-branch-summary.sh with BRANCH_SUMMARY_CMD mock for tests; BATS tests for timeout and error paths

## Testing

- [x] Tests pass locally (`just test-bats` — all 12 worktree tests pass)
- [ ] Manual testing performed (describe below)

### Manual Testing Details

N/A — BATS tests cover derive-branch-summary success, timeout, and error paths. Manual verification of gh preflight and agent timeout can be done by reproducing the conditions in the issue.

## Checklist

- [x] My code follows the project's style guidelines
- [x] I have performed a self-review of my code
- [x] I have commented my code, particularly in hard-to-understand areas
- [ ] I have updated the documentation accordingly (edit `docs/templates/`, then run `just docs`)
- [x] I have updated `CHANGELOG.md` in the `[Unreleased]` section (and pasted the entry above)
- [x] My changes generate no new warnings or errors
- [x] I have added tests that prove my fix is effective or that my feature works
- [x] New and existing unit tests pass locally with my changes
- [x] Any dependent changes have been merged and published

## Additional Notes

N/A

Refs: #154

