---
type: pull_request
state: open
branch: bugfix/132-worktree-attach-stopped-session → dev
created: 2026-02-21T00:55:23Z
updated: 2026-02-21T01:08:37Z
author: gerchowl
author_url: https://github.com/gerchowl
url: https://github.com/vig-os/devcontainer/pull/137
comments: 0
labels: none
assignees: gerchowl
milestone: none
projects: none
relationship: none
synced: 2026-02-21T04:11:21.660Z
---

# [PR 137](https://github.com/vig-os/devcontainer/pull/137) fix(worktree): worktree-attach restarts stopped session when worktree exists

## Description

When a worktree exists but its tmux session has been terminated (shown as `[STOPPED]` in `just wt-list`), `just wt-attach` now detects the existing worktree directory and automatically restarts the tmux session before attaching, instead of failing with a misleading error.

## Type of Change

- [x] `fix` -- Bug fix

### Modifiers

- [ ] Breaking change (`!`) -- This change breaks backward compatibility

## Changes Made

- **worktree-attach**: When `tmux has-session` fails, check if the worktree directory exists. If so, restart the tmux session (reusing the pattern from `worktree-start`) before attaching.
- **Trust handling**: Added `_wt_ensure_trust` to the attach recipe so restarted sessions have the worktree in `trustedDirectories`.
- **Test support**: `WORKTREE_ATTACH_RESTART_CMD` env var allows BATS tests to use a simple command (e.g. `sleep 5`) instead of `agent chat`, avoiding agent dependency in CI.
- **BATS tests**: Two new tests in `tests/bats/worktree.bats` — restart on stopped session with existing dir, and error when neither dir nor session exists.

## Changelog Entry

### Fixed

- **worktree-attach restarts stopped tmux session when worktree dir exists** ([#132](https://github.com/vig-os/devcontainer/issues/132))
  - Detect when worktree directory exists but tmux session has terminated
  - Automatically restart session in existing worktree before attaching
  - BATS integration tests for restart and error paths

## Testing

- [x] Tests pass locally (`just test-bats` — all 7 worktree tests pass)
- [x] Manual testing performed

### Manual Testing Details

- Created worktree dir, started tmux session with `true` (exits immediately), verified session gone, ran `just worktree-attach` — session restarted and attach succeeded.
- Ran `just worktree-attach` for non-existent issue — correct error message.

## Checklist

- [x] My code follows the project's style guidelines
- [x] I have performed a self-review of my code
- [x] I have commented my code, particularly in hard-to-understand areas
- [x] I have updated the documentation accordingly (edit `docs/templates/`, then run `just docs`)
- [x] I have updated `CHANGELOG.md` in the `[Unreleased]` section (and pasted the entry above)
- [x] My changes generate no new warnings or errors
- [x] I have added tests that prove my fix is effective or that my feature works
- [x] New and existing unit tests pass locally with my changes
- [x] Any dependent changes have been merged and published

## Additional Notes

Closes #132

Refs: #132

