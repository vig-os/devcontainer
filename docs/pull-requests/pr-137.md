---
type: pull_request
state: closed (merged)
branch: bugfix/132-worktree-attach-stopped-session → dev
created: 2026-02-21T00:55:23Z
updated: 2026-02-21T10:10:33Z
author: gerchowl
author_url: https://github.com/gerchowl
url: https://github.com/vig-os/devcontainer/pull/137
comments: 0
labels: none
assignees: gerchowl
milestone: none
projects: none
relationship: none
merged: 2026-02-21T10:10:30Z
synced: 2026-02-22T04:23:40.038Z
---

# [PR 137](https://github.com/vig-os/devcontainer/pull/137) fix(worktree): worktree-attach restarts stopped session when worktree exists

## Description

When a worktree exists but its tmux session has been terminated (shown as `[STOPPED]` in `just wt-list`), `just wt-attach` now detects the existing worktree directory and automatically restarts the tmux session before attaching, instead of failing with a misleading error.

## Type of Change

- [x] `fix` -- Bug fix

### Modifiers

- [ ] Breaking change (`!`) -- This change breaks backward compatibility

## Changes Made

- **worktree-attach**: When `tmux has-session` fails, check if the worktree directory exists. If so, restart the tmux session (reusing the pattern from `worktree-start`) before attaching.
- **Trust handling**: Added `_wt_ensure_trust` to the attach recipe so restarted sessions have the worktree in `trustedDirectories`.
- **Test support**: `WORKTREE_ATTACH_RESTART_CMD` env var allows BATS tests to use a simple command (e.g. `sleep 5`) instead of `agent chat`, avoiding agent dependency in CI.
- **BATS tests**: Two new tests in `tests/bats/worktree.bats` — restart on stopped session with existing dir, and error when neither dir nor session exists.

## Changelog Entry

### Fixed

- **worktree-attach restarts stopped tmux session when worktree dir exists** ([#132](https://github.com/vig-os/devcontainer/issues/132))
  - Detect when worktree directory exists but tmux session has terminated
  - Automatically restart session in existing worktree before attaching
  - BATS integration tests for restart and error paths

## Testing

- [x] Tests pass locally (`just test-bats` — all 7 worktree tests pass)
- [x] Manual testing performed

### Manual Testing Details

- Created worktree dir, started tmux session with `true` (exits immediately), verified session gone, ran `just worktree-attach` — session restarted and attach succeeded.
- Ran `just worktree-attach` for non-existent issue — correct error message.

## Checklist

- [x] My code follows the project's style guidelines
- [x] I have performed a self-review of my code
- [x] I have commented my code, particularly in hard-to-understand areas
- [x] I have updated the documentation accordingly (edit `docs/templates/`, then run `just docs`)
- [x] I have updated `CHANGELOG.md` in the `[Unreleased]` section (and pasted the entry above)
- [x] My changes generate no new warnings or errors
- [x] I have added tests that prove my fix is effective or that my feature works
- [x] New and existing unit tests pass locally with my changes
- [x] Any dependent changes have been merged and published

## Additional Notes

Closes #132

Refs: #132



---
---

## Commits

### Commit 1: [c3271ca](https://github.com/vig-os/devcontainer/commit/c3271ca2c2f2143ef750942ec786fa707cfc66f6) by [gerchowl](https://github.com/gerchowl) on February 21, 2026 at 12:49 AM
fix(worktree): remove --trust from agent chat invocations, 8 files modified (justfile.worktree)

### Commit 2: [97ad45c](https://github.com/vig-os/devcontainer/commit/97ad45cf8ca9a92d782c19c13d691d99c7033d2d) by [gerchowl](https://github.com/gerchowl) on February 21, 2026 at 12:53 AM
test(worktree): add BATS tests for worktree-attach restart logic, 42 files modified (tests/bats/worktree.bats)

### Commit 3: [413e235](https://github.com/vig-os/devcontainer/commit/413e23579e2ea249663dbf8a0c04408ccb4d0b64) by [gerchowl](https://github.com/gerchowl) on February 21, 2026 at 12:54 AM
fix(worktree): restart tmux session when worktree dir exists but session stopped, 48 files modified (justfile.worktree, tests/bats/worktree.bats)

### Commit 4: [5ce8819](https://github.com/vig-os/devcontainer/commit/5ce8819339ce67356cfaf1b80eca95d2dd8d3ddc) by [gerchowl](https://github.com/gerchowl) on February 21, 2026 at 12:54 AM
docs: add CHANGELOG entry for worktree-attach restart fix, 7 files modified (CHANGELOG.md)

### Commit 5: [f2947df](https://github.com/vig-os/devcontainer/commit/f2947dfa11b31946c516e74f814b37d0e62c3f3f) by [gerchowl](https://github.com/gerchowl) on February 21, 2026 at 01:02 AM
fix(worktree): auto-approve trust prompt after tmux session launch, 3 files modified (justfile.worktree)

### Commit 6: [68af239](https://github.com/vig-os/devcontainer/commit/68af239776c8066d3820a4943cc6c606f488c86c) by [gerchowl](https://github.com/gerchowl) on February 21, 2026 at 01:04 AM
test: verify tmux send-keys delivers trust approval to session, 21 files modified (tests/bats/worktree.bats)

### Commit 7: [3e3b2ff](https://github.com/vig-os/devcontainer/commit/3e3b2ff2086455142dd1b3b63bac4f63f4ff18f7) by [gerchowl](https://github.com/gerchowl) on February 21, 2026 at 01:06 AM
test: skip tmux integration tests in CI, 3 files modified (tests/bats/worktree.bats)

### Commit 8: [a7a8add](https://github.com/vig-os/devcontainer/commit/a7a8add62a42ffdc1208ca623640e804c22002e5) by [gerchowl](https://github.com/gerchowl) on February 21, 2026 at 01:08 AM
test: verify send-keys approves agent trust prompt in tmux, 23 files modified (tests/bats/worktree.bats)
