---
type: pull_request
state: closed (merged)
branch: bugfix/132-worktree-attach-stopped-session → dev
created: 2026-02-21T18:23:58Z
updated: 2026-02-21T20:58:43Z
author: gerchowl
author_url: https://github.com/gerchowl
url: https://github.com/vig-os/devcontainer/pull/141
comments: 0
labels: none
assignees: gerchowl
milestone: none
projects: none
relationship: none
merged: 2026-02-21T20:58:41Z
synced: 2026-02-22T04:23:32.977Z
---

# [PR 141](https://github.com/vig-os/devcontainer/pull/141) fix(worktree): detect branch already checked out before creating worktree

## Description

Add a pre-flight guard to `worktree-start` that detects when the target branch is already checked out in another working tree (or the main repo). Instead of letting `git worktree add` fail with a cryptic fatal error, the recipe now prints an informative message showing where the branch is checked out and how to resolve it.

## Type of Change

- [ ] `feat` -- New feature
- [x] `fix` -- Bug fix
- [ ] `docs` -- Documentation only
- [ ] `chore` -- Maintenance task (deps, config, etc.)
- [ ] `refactor` -- Code restructuring (no behavior change)
- [x] `test` -- Adding or updating tests
- [ ] `ci` -- CI/CD pipeline changes
- [ ] `build` -- Build system or dependency changes
- [ ] `revert` -- Reverts a previous commit
- [ ] `style` -- Code style (formatting, whitespace)

### Modifiers

- [ ] Breaking change (`!`) -- This change breaks backward compatibility

## Changes Made

- **`justfile.worktree`**: Added branch-already-checked-out detection before `git worktree add` using `git worktree list --porcelain`. Prints the checkout path and remediation commands on failure.
- **`tests/bats/worktree.bats`**: Added BATS test validating the detection pattern (`git worktree list --porcelain | grep branch`).
- **`CHANGELOG.md`**: Updated the existing #132 entry with the new guard and test coverage.
- **`assets/workspace/.devcontainer/justfile.worktree`**: Synced workspace copy.

## Changelog Entry

### Fixed

- **worktree-attach restarts stopped tmux session when worktree dir exists** ([#132](https://github.com/vig-os/devcontainer/issues/132))
  - Detect when worktree directory exists but tmux session has terminated
  - Automatically restart session in existing worktree before attaching
  - Guard `worktree-start` against branches already checked out elsewhere with an informative error
  - BATS integration tests for restart, error paths, and checkout detection

## Testing

- [x] Tests pass locally (`just test`)
- [x] Manual testing performed (describe below)

### Manual Testing Details

- Checked out a branch in the main repo, then attempted `git worktree add` for the same branch — confirmed git refuses. Verified the `git worktree list --porcelain` detection pattern correctly identifies the checkout location.
- Full test suite: 232 pytest passed (1 skipped) + 222 BATS passed.

## Checklist

- [x] My code follows the project's style guidelines
- [x] I have performed a self-review of my code
- [x] I have commented my code, particularly in hard-to-understand areas
- [ ] I have updated the documentation accordingly (edit `docs/templates/`, then run `just docs`)
- [x] I have updated `CHANGELOG.md` in the `[Unreleased]` section (and pasted the entry above)
- [x] My changes generate no new warnings or errors
- [x] I have added tests that prove my fix is effective or that my feature works
- [x] New and existing unit tests pass locally with my changes
- [x] Any dependent changes have been merged and published

## Additional Notes

This PR builds on top of the earlier #132 work (merged as #137) which added the `worktree-attach` restart logic. This follow-up addresses the remaining gap: `worktree-start` failing when a branch is already checked out.

Refs: #132



---
---

## Commits

### Commit 1: [bda09d6](https://github.com/vig-os/devcontainer/commit/bda09d69dd3529beaf8507d36d666fb1ef4b86ee) by [gerchowl](https://github.com/gerchowl) on February 21, 2026 at 06:03 PM
test(worktree): add BATS test for branch-already-checked-out detection, 19 files modified (tests/bats/worktree.bats)

### Commit 2: [1e44f84](https://github.com/vig-os/devcontainer/commit/1e44f84948a403c3ed2d115a5e558946a0f2aa73) by [gerchowl](https://github.com/gerchowl) on February 21, 2026 at 06:06 PM
fix(worktree): detect branch already checked out before git worktree add, 12 files modified (justfile.worktree)

### Commit 3: [30477c2](https://github.com/vig-os/devcontainer/commit/30477c2815a6f74b5a2931cf5ad8e0c982379c5f) by [gerchowl](https://github.com/gerchowl) on February 21, 2026 at 06:07 PM
docs: update CHANGELOG for worktree-start checkout guard, 3 files modified (CHANGELOG.md)

### Commit 4: [19c8131](https://github.com/vig-os/devcontainer/commit/19c8131c4f19d919e3ad27f45372df48508b537d) by [gerchowl](https://github.com/gerchowl) on February 21, 2026 at 06:11 PM
chore: sync justfile.worktree to workspace asset, 67 files modified (assets/workspace/.devcontainer/justfile.worktree)

### Commit 5: [41a6fe9](https://github.com/vig-os/devcontainer/commit/41a6fe9474eb3164007bcb54efdccc13732b6609) by [gerchowl](https://github.com/gerchowl) on February 21, 2026 at 06:38 PM
fix(worktree): configure git identity in BATS test temp repo, 2 files modified (tests/bats/worktree.bats)
