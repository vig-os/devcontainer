---
type: pull_request
state: closed (merged)
branch: dev â†’ main
created: 2026-01-28T10:09:21Z
updated: 2026-01-28T10:19:01Z
author: c-vigo
author_url: https://github.com/c-vigo
url: https://github.com/vig-os/devcontainer/pull/31
comments: 0
labels: none
assignees: c-vigo
milestone: none
projects: none
relationship: none
merged: 2026-01-28T10:18:45Z
synced: 2026-01-28T10:19:13.027Z
---

# [PR 31](https://github.com/vig-os/devcontainer/pull/31) fix: improve multi-platform support in Containerfile

## Description

Fixes a critical bug in the Containerfile that prevented multi-platform builds from working correctly. The `TARGETARCH` ARG had a default value (`amd64`) that was overriding Docker BuildKit's automatic platform detection, causing builds to download incorrect architecture-specific binaries and fail with "Exec format error".

## Related Issue(s)

Closes #

## Type of Change

- [x] Bug fix (non-breaking change which fixes an issue)
- [ ] New feature (non-breaking change which adds functionality)
- [ ] Breaking change (fix or feature that would cause existing functionality to not work as expected)
- [ ] Documentation update
- [ ] Refactoring (no functional changes)
- [ ] Test updates

## Changes Made

### Containerfile (line 60)
- **Before**: `ARG TARGETARCH=amd64`
- **After**: `ARG TARGETARCH`
- Added clarifying comment explaining that TARGETARCH is automatically provided by Docker BuildKit

### Workflow (publish-container-image.yml)
- Fixed image tagging after podman load in "Load image for testing" step
- The workflow now explicitly tags the loaded image with the expected name (`ghcr.io/vig-os/devcontainer:VERSION-ARCH`)
- This ensures tests can find and use the correct image

### CHANGELOG.md
- Added entry in version 0.2.1 documenting the multi-platform build fix

### Root Cause
The default value `=amd64` was overriding Docker BuildKit's automatic platform detection. When building for arm64, the build would still use `amd64` as the value, causing it to download amd64 binaries (GitHub CLI, uv) which would fail to execute on arm64 with "Exec format error".

### Error Symptoms (Before Fix)

**Build Error:**
```
#11 1.309 /bin/sh: 1: gh: Exec format error
ERROR: process "/bin/sh -c ... gh --version;" did not complete successfully: exit code: 126
```

**Test Error (after Containerfile fix but before workflow fix):**
```
Loading image from /tmp/image.tar into podman...
Loaded image(s): localhost/99.0.1-arm64:latest
##[error]Process completed with exit code 1.
```
Podman couldn't find the image with expected tag `ghcr.io/vig-os/devcontainer`

## Testing

- [x] Tests pass locally (`just test`)
- [x] Manual testing performed (describe below)

### Manual Testing Details

**Before the fix:**
- Building for arm64 failed with "Exec format error" when executing downloaded binaries
- GitHub CLI and uv binaries were incorrectly downloaded as amd64 versions

**After the fix:**
- Multi-platform builds complete successfully for both amd64 and arm64
- Architecture-specific binaries are correctly downloaded based on target platform
- Images are properly tagged and available for testing
- Running `just clean && just build && just test` completes without errors

**Verification commands:**
```bash
# Build for specific architectures
docker buildx build --platform linux/amd64 .
docker buildx build --platform linux/arm64 .
```

## Checklist

- [x] My code follows the project's style guidelines
- [x] I have performed a self-review of my code
- [x] I have commented my code, particularly in hard-to-understand areas
- [x] I have updated the documentation accordingly (README.md, CONTRIBUTE.md, etc.)
- [x] I have updated the CHANGELOG.md in the `[Unreleased]` section
- [x] My changes generate no new warnings or errors
- [ ] I have added tests that prove my fix is effective or that my feature works
- [x] New and existing unit tests pass locally with my changes
- [x] Any dependent changes have been merged and published

## Additional Notes

### Impact
This is a critical fix that enables the multi-platform container image publishing workflow to function correctly. Without this fix:
- ARM64 builds would always fail
- Multi-architecture manifests could not be created
- The project could only be built for amd64 architecture

### Technical Details
Docker BuildKit provides several built-in ARGs for multi-platform builds:
- `TARGETPLATFORM` - e.g., `linux/amd64`, `linux/arm64`
- `TARGETOS` - e.g., `linux`
- `TARGETARCH` - e.g., `amd64`, `arm64`

These ARGs are automatically set based on the `--platform` flag. By declaring `ARG TARGETARCH` without a default value, we allow BuildKit to inject the correct value for each platform being built.



---
---

## Commits

### Commit 1: [acb5a91](https://github.com/vig-os/devcontainer/commit/acb5a915a7a5a1d85e0460e7ce64baaa3a849315) by [c-vigo](https://github.com/c-vigo) on January 28, 2026 at 10:05 AM
fix: improve multi-platform support in Containerfile and update CHANGELOG, 7 files modified (CHANGELOG.md, Containerfile)

### Commit 2: [9ca278f](https://github.com/vig-os/devcontainer/commit/9ca278f806a663af98e01f6b293aeb4be9d86516) by [commit-action-bot[bot]](https://github.com/apps/commit-action-bot) on January 28, 2026 at 10:09 AM
chore: sync issues and PRs, 107 files modified (.github_data/pull-requests/pr-31.md)

### Commit 3: [fe07e4c](https://github.com/vig-os/devcontainer/commit/fe07e4c23a2f77c439fab49590c8dcf28bb6859c) by [c-vigo](https://github.com/c-vigo) on January 28, 2026 at 10:12 AM
fix: enhance podman image loading and tagging in GitHub Actions workflow, 16 files modified (.github/workflows/publish-container-image.yml, CHANGELOG.md)

### Commit 4: [76e7fab](https://github.com/vig-os/devcontainer/commit/76e7fab6ee7f67ab56e264875f33bbf62aa4e1a4) by [commit-action-bot[bot]](https://github.com/apps/commit-action-bot) on January 28, 2026 at 10:14 AM
chore: sync issues and PRs, 20 files modified (.github_data/pull-requests/pr-31.md)
