---
type: pull_request
state: open
branch: dev â†’ main
created: 2026-01-28T10:09:21Z
updated: 2026-01-28T10:09:21Z
author: c-vigo
author_url: https://github.com/c-vigo
url: https://github.com/vig-os/devcontainer/pull/31
comments: 0
labels: none
assignees: c-vigo
milestone: none
projects: none
relationship: none
synced: 2026-01-28T10:09:38.609Z
---

# [PR 31](https://github.com/vig-os/devcontainer/pull/31) fix: improve multi-platform support in Containerfile

## Description

Fixes a critical bug in the Containerfile that prevented multi-platform builds from working correctly. The `TARGETARCH` ARG had a default value (`amd64`) that was overriding Docker BuildKit's automatic platform detection, causing builds to download incorrect architecture-specific binaries and fail with "Exec format error".

## Related Issue(s)

Closes #

## Type of Change

- [x] Bug fix (non-breaking change which fixes an issue)
- [ ] New feature (non-breaking change which adds functionality)
- [ ] Breaking change (fix or feature that would cause existing functionality to not work as expected)
- [ ] Documentation update
- [ ] Refactoring (no functional changes)
- [ ] Test updates

## Changes Made

### Containerfile (line 60)
- **Before**: `ARG TARGETARCH=amd64`
- **After**: `ARG TARGETARCH`
- Added clarifying comment explaining that TARGETARCH is automatically provided by Docker BuildKit

### CHANGELOG.md
- Added entry in version 0.2.1 documenting the multi-platform build fix

### Root Cause
The default value `=amd64` was overriding Docker BuildKit's automatic platform detection. When building for arm64, the build would still use `amd64` as the value, causing it to download amd64 binaries (GitHub CLI, uv) which would fail to execute on arm64 with "Exec format error".

### Error Symptoms (Before Fix)
```
#11 1.309 /bin/sh: 1: gh: Exec format error
ERROR: process "/bin/sh -c ... gh --version;" did not complete successfully: exit code: 126
```

## Testing

- [x] Tests pass locally (`just test`)
- [x] Manual testing performed (describe below)

### Manual Testing Details

**Before the fix:**
- Building for arm64 failed with "Exec format error" when executing downloaded binaries
- GitHub CLI and uv binaries were incorrectly downloaded as amd64 versions

**After the fix:**
- Multi-platform builds complete successfully for both amd64 and arm64
- Architecture-specific binaries are correctly downloaded based on target platform
- Running `just clean && just build && just test` completes without errors

**Verification commands:**
```bash
# Build for specific architectures
docker buildx build --platform linux/amd64 .
docker buildx build --platform linux/arm64 .
```

## Checklist

- [x] My code follows the project's style guidelines
- [x] I have performed a self-review of my code
- [x] I have commented my code, particularly in hard-to-understand areas
- [x] I have updated the documentation accordingly (README.md, CONTRIBUTE.md, etc.)
- [x] I have updated the CHANGELOG.md in the `[Unreleased]` section
- [x] My changes generate no new warnings or errors
- [ ] I have added tests that prove my fix is effective or that my feature works
- [x] New and existing unit tests pass locally with my changes
- [x] Any dependent changes have been merged and published

## Additional Notes

### Impact
This is a critical fix that enables the multi-platform container image publishing workflow to function correctly. Without this fix:
- ARM64 builds would always fail
- Multi-architecture manifests could not be created
- The project could only be built for amd64 architecture

### Technical Details
Docker BuildKit provides several built-in ARGs for multi-platform builds:
- `TARGETPLATFORM` - e.g., `linux/amd64`, `linux/arm64`
- `TARGETOS` - e.g., `linux`
- `TARGETARCH` - e.g., `amd64`, `arm64`

These ARGs are automatically set based on the `--platform` flag. By declaring `ARG TARGETARCH` without a default value, we allow BuildKit to inject the correct value for each platform being built.

