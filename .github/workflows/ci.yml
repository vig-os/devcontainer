# CI Workflow
#
# This workflow runs automated tests and linters to validate code quality.
# Runs on pull requests to dev, release/**, and main branches as a pre-merge gate.
#
# Jobs:
#   1. build-image - Build container image
#   2. test-image - Run image tests
#   3. test-integration - Run integration tests
#   4. project-checks - Linters, utils, release cycle tests
#   5. security-scan - Container image vulnerability scanning (Trivy)
#   6. dependency-review - Dependency vulnerability check (PRs only)
#
# Triggers:
#   - Pull requests to dev, release/**, and main (runs all suites)
#   - Manual workflow_dispatch (select specific test suite to run)

name: CI

on:  # yamllint disable-line rule:truthy
  pull_request:
    branches:
      - dev
      - 'release/**'
      - main
  workflow_dispatch:
    inputs:
      test-suite:
        description: 'Test suite to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - image
          - integration
          - project

permissions:
  contents: read

jobs:
  build-image:
    name: Build Container Image
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    # Build image once and share via tar artifact to avoid rebuilding in each test job
    # Trade-off: tar transfer is slower but ensures all tests use identical image
    if: |
      github.event_name != 'workflow_dispatch' ||
      inputs.test-suite == 'all' ||
      inputs.test-suite == 'image' ||
      inputs.test-suite == 'integration'

    outputs:
      version: ${{ steps.version.outputs.version }}
      release_date: ${{ steps.version.outputs.release_date }}
      release_url: ${{ steps.version.outputs.release_url }}
      build_timestamp: ${{ steps.version.outputs.build_timestamp }}

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Generate version for dev build
        id: version
        run: |
          VERSION="dev-$(git rev-parse --short HEAD)"
          RELEASE_DATE=$(date -u +%Y-%m-%d)
          BUILD_TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          RELEASE_URL="https://github.com/${GITHUB_REPOSITORY}/commit/$(git rev-parse HEAD)"

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "release_date=$RELEASE_DATE" >> $GITHUB_OUTPUT
          echo "build_timestamp=$BUILD_TIMESTAMP" >> $GITHUB_OUTPUT
          echo "release_url=$RELEASE_URL" >> $GITHUB_OUTPUT
          echo "Building dev version: $VERSION"

      - name: Build container image
        uses: ./.github/actions/build-image
        with:
          version: ${{ steps.version.outputs.version }}
          arch: amd64
          release-date: ${{ steps.version.outputs.release_date }}
          release-url: ${{ steps.version.outputs.release_url }}
          build-timestamp: ${{ steps.version.outputs.build_timestamp }}
          vcs-ref: ${{ github.sha }}
          output-type: tar
          output-file: /tmp/image.tar

      - name: Upload image artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4
        with:
          name: container-image-${{ steps.version.outputs.version }}-amd64
          path: /tmp/image.tar
          retention-days: 1
          compression-level: 0   # Image is already compressed; avoid double-compression overhead

  test-image:
    name: Image Tests
    needs: build-image
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    if: |
      github.event_name != 'workflow_dispatch' ||
      inputs.test-suite == 'all' ||
      inputs.test-suite == 'image'

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Download image artifact
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093  # v4
        with:
          name: container-image-${{ needs.build-image.outputs.version }}-amd64
          path: /tmp

      - name: Test container image
        uses: ./.github/actions/test-image
        with:
          image-tag: ${{ needs.build-image.outputs.version }}-amd64
          image-source: tar

  test-integration:
    name: Integration Tests
    needs: build-image
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    if: |
      github.event_name != 'workflow_dispatch' ||
      inputs.test-suite == 'all' ||
      inputs.test-suite == 'integration'

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Download image artifact
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093  # v4
        with:
          name: container-image-${{ needs.build-image.outputs.version }}-amd64
          path: /tmp

      - name: Run integration tests
        uses: ./.github/actions/test-integration
        with:
          image-tag: ${{ needs.build-image.outputs.version }}-amd64

      - name: Upload test artifacts on failure
        if: failure()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4
        with:
          name: integration-test-artifacts
          path: |
            pytest-*.log
            /tmp/workspace-*
          retention-days: 7
          if-no-files-found: ignore

  project-checks:
    name: Project Checks
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    if: |
      github.event_name != 'workflow_dispatch' ||
      inputs.test-suite == 'all' ||
      inputs.test-suite == 'project'

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Run project checks
        uses: ./.github/actions/test-project

  python-security:
    name: Python Security Scan
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    if: |
      github.event_name != 'workflow_dispatch' ||
      inputs.test-suite == 'all' ||
      inputs.test-suite == 'project'

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Set up environment
        uses: ./.github/actions/setup-env
        with:
          sync-dependencies: 'true'

      - name: Install safety
        run: uv pip install safety==3.2.11

      - name: Run Bandit (Python security linting)
        id: bandit
        run: |
          uv run bandit -r scripts/ assets/workspace/ -ll -f json -o bandit-report.json || true
          echo "Bandit scan completed"

      - name: Run Safety (dependency vulnerability check)
        id: safety
        run: |
          safety check --json > safety-report.json || true
          echo "Safety scan completed"

      - name: Upload security reports as artifacts
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4
        with:
          name: python-security-reports
          path: |
            bandit-report.json
            safety-report.json
          retention-days: 30
          if-no-files-found: ignore

      - name: Report Bandit findings
        if: always() && steps.bandit.outcome == 'success'
        run: |
          if [ -f bandit-report.json ]; then
            echo "## Python Security: Bandit" >> $GITHUB_STEP_SUMMARY
            python -m json.tool bandit-report.json | head -50 >> $GITHUB_STEP_SUMMARY || true
          fi

  security-scan:
    name: Security Scan
    needs: build-image
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    if: |
      github.event_name != 'workflow_dispatch' ||
      inputs.test-suite == 'all' ||
      inputs.test-suite == 'image'
    permissions:
      contents: read
      security-events: write    # upload SARIF results to GitHub Security tab

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Download image artifact
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093  # v4
        with:
          name: container-image-${{ needs.build-image.outputs.version }}-amd64
          path: /tmp

      - name: Scan image for vulnerabilities
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8  # v0.33.1
        with:
          input: /tmp/image.tar
          format: 'table'
          severity: 'HIGH,CRITICAL'
          exit-code: '1'
          ignore-unfixed: true
          trivyignores: '.trivyignore'

      - name: Report unfixed HIGH/CRITICAL vulnerabilities (non-blocking)
        if: always()
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8  # v0.33.1
        with:
          input: /tmp/image.tar
          format: 'table'
          severity: 'HIGH,CRITICAL'
          exit-code: '0'
          trivyignores: '.trivyignore'

      - name: Report MEDIUM severity vulnerabilities (non-blocking)
        if: always()
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8  # v0.33.1
        with:
          input: /tmp/image.tar
          format: 'table'
          severity: 'MEDIUM'
          exit-code: '0'  # Non-blocking report

      - name: Generate container SBOM (CycloneDX)
        if: always()
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8  # v0.33.1
        with:
          input: /tmp/image.tar
          format: 'cyclonedx'
          output: 'sbom-cyclonedx.json'

      - name: Generate SARIF report
        if: always()
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8  # v0.33.1
        with:
          input: /tmp/image.tar
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'HIGH,CRITICAL'
          trivyignores: '.trivyignore'

      - name: Upload SBOM artifact
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4
        with:
          name: sbom-${{ needs.build-image.outputs.version }}-amd64
          path: sbom-cyclonedx.json
          retention-days: 30

      - name: Upload SARIF to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@45cbd0c69e560cd9e7cd7f8c32362050c9b7ded2  # v4
        with:
          sarif_file: trivy-results.sarif
          category: 'container-image'

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Validate dependency-review exceptions
        id: exceptions
        run: |
          FILE=".github/dependency-review-allow.txt"
          if [[ ! -f "$FILE" ]]; then
            echo "No exceptions file found — skipping"
            echo "allow-ghsas=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          TODAY=$(date +%Y-%m-%d)
          EXPIRED=()
          VALID=()
          EXPIRATION=""

          while IFS= read -r line || [[ -n "$line" ]]; do
            # Skip blank lines and comments
            [[ -z "$line" || "$line" =~ ^[[:space:]]*# ]] && continue

            # Parse Expiration directive
            if [[ "$line" =~ ^Expiration:[[:space:]]*([0-9]{4}-[0-9]{2}-[0-9]{2}) ]]; then
              EXPIRATION="${BASH_REMATCH[1]}"
              continue
            fi

            # Parse GHSA identifier
            if [[ "$line" =~ ^GHSA- ]]; then
              ghsa="${line%%[[:space:]]*}"
              if [[ -z "$EXPIRATION" ]]; then
                echo "::error::${ghsa} has no Expiration directive"
                exit 1
              fi
              if [[ "$TODAY" > "$EXPIRATION" ]]; then
                EXPIRED+=("${ghsa} (expired ${EXPIRATION})")
              else
                VALID+=("$ghsa")
              fi
              EXPIRATION=""
            fi
          done < "$FILE"

          if [[ ${#EXPIRED[@]} -gt 0 ]]; then
            echo "::error::Expired dependency-review exceptions — review and renew or remove:"
            for entry in "${EXPIRED[@]}"; do
              echo "::error::  - ${entry}"
            done
            exit 1
          fi

          GHSA_LIST=""
          for i in "${!VALID[@]}"; do
            [[ $i -gt 0 ]] && GHSA_LIST+=", "
            GHSA_LIST+="${VALID[$i]}"
          done
          echo "allow-ghsas=${GHSA_LIST}" >> "$GITHUB_OUTPUT"
          echo "Validated ${#VALID[@]} exception(s): ${GHSA_LIST:-none}"

      - name: Review dependencies for vulnerabilities
        uses: actions/dependency-review-action@3c4e3dcb1aa7874d2c16be7d79418e9b7efd6261  # v4
        with:
          fail-on-severity: high
          allow-ghsas: ${{ steps.exceptions.outputs.allow-ghsas }}

  summary:
    name: Test Summary
    runs-on: ubuntu-22.04
    timeout-minutes: 5
    needs:
      - build-image
      - test-image
      - test-integration
      - project-checks
      - python-security
      - security-scan
      - dependency-review
    if: always()

    steps:
      - name: Check test results
        run: |
          echo "Test Results Summary"
          echo "======================="
          echo ""
          echo "Build Image: ${{ needs.build-image.result }}"
          echo "Image Tests: ${{ needs.test-image.result }}"
          echo "Integration Tests: ${{ needs.test-integration.result }}"
          echo "Project Checks: ${{ needs.project-checks.result }}"
          echo "Python Security: ${{ needs.python-security.result }}"
          echo "Security Scan: ${{ needs.security-scan.result }}"
          echo "Dependency Review: ${{ needs.dependency-review.result }}"
          echo ""

          # Check if any job that ran has failed (skip 'skipped' jobs)
          FAILED=false

          if [ "${{ needs.build-image.result }}" = "failure" ]; then
            echo "ERROR: Build image failed"
            FAILED=true
          fi

          if [ "${{ needs.test-image.result }}" = "failure" ]; then
            echo "ERROR: Image tests failed"
            FAILED=true
          fi

          if [ "${{ needs.test-integration.result }}" = "failure" ]; then
            echo "ERROR: Integration tests failed"
            FAILED=true
          fi

          if [ "${{ needs.project-checks.result }}" = "failure" ]; then
            echo "ERROR: Project checks failed"
            FAILED=true
          fi

          if [ "${{ needs.python-security.result }}" = "failure" ]; then
            echo "ERROR: Python security scan failed"
            FAILED=true
          fi

          if [ "${{ needs.security-scan.result }}" = "failure" ]; then
            echo "ERROR: Security scan failed"
            FAILED=true
          fi

          if [ "${{ needs.dependency-review.result }}" = "failure" ]; then
            echo "ERROR: Dependency review failed"
            FAILED=true
          fi

          if [ "$FAILED" = "true" ]; then
            echo ""
            echo "One or more test suites failed"
            exit 1
          fi

          echo ""
          echo "All executed test suites passed"
