#!/usr/bin/env bash
# Build container image
# Usage: build.sh <version> [REPO] [NATIVE_PLATFORM]

set -e

echo "ðŸ” DEBUG: Script started"
echo "ðŸ” DEBUG: Arguments: \$1='$1' \$2='$2' \$3='$3'"

VERSION="${1:-dev}"
REPO="${2:-${TEST_REGISTRY:-ghcr.io/vig-os/devcontainer}}"
echo "ðŸ” DEBUG: VERSION='$VERSION'"
echo "ðŸ” DEBUG: REPO (before cleanup)='$REPO'"

# Remove trailing slash from REPO to avoid invalid tag format (e.g., localhost:5000/test/:tag)
REPO="${REPO%/}"
echo "ðŸ” DEBUG: REPO (after cleanup)='$REPO'"

# Detect native platform
NATIVE_ARCH=$(uname -m)
echo "ðŸ” DEBUG: Detected architecture: $NATIVE_ARCH"

if [ "$NATIVE_ARCH" = "arm64" ] || [ "$NATIVE_ARCH" = "aarch64" ]; then
	NATIVE_PLATFORM="${3:-linux/arm64}"
else
	NATIVE_PLATFORM="${3:-linux/amd64}"
fi
echo "ðŸ” DEBUG: NATIVE_PLATFORM='$NATIVE_PLATFORM'"

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
echo "ðŸ” DEBUG: SCRIPT_DIR='$SCRIPT_DIR'"
echo "ðŸ” DEBUG: PROJECT_ROOT='$PROJECT_ROOT'"

# Source utilities
# shellcheck source=scripts/utils.sh
source "$SCRIPT_DIR/utils.sh"

cd "$PROJECT_ROOT"
echo "ðŸ” DEBUG: Changed to PROJECT_ROOT"

BUILD_DIR="build"
BUILD_VERSION="$VERSION"
BUILD_DATE=""
VCS_REF=""
echo "ðŸ” DEBUG: BUILD_DIR='$BUILD_DIR'"
echo "ðŸ” DEBUG: BUILD_VERSION='$BUILD_VERSION'"
echo "ðŸ” DEBUG: BUILD_DATE='$BUILD_DATE'"
echo "ðŸ” DEBUG: VCS_REF='$VCS_REF'"

echo "Building $REPO:$VERSION..."

# Create and clear build folder
echo "Preparing build folder..."
echo "ðŸ” DEBUG: Removing existing build directory..."
rm -rf "$BUILD_DIR"
echo "ðŸ” DEBUG: Creating build directory..."
mkdir -p "$BUILD_DIR"
echo "ðŸ” DEBUG: Build directory created"

# Copy Containerfile and assets to build folder
echo "Copying Containerfile and assets to build folder..."
echo "ðŸ” DEBUG: Copying Containerfile..."
cp Containerfile "$BUILD_DIR/"
echo "ðŸ” DEBUG: Copying assets directory..."
cp -r assets "$BUILD_DIR/"
echo "ðŸ” DEBUG: Files copied successfully"

# Modify assets if needed (replace version placeholders)
if [ -d "$BUILD_DIR/assets/workspace" ]; then
	echo "Replacing {{IMAGE_TAG}} with $BUILD_VERSION in template files..."
	echo "ðŸ” DEBUG: Searching for files in $BUILD_DIR/assets/workspace..."
	echo "ðŸ” DEBUG: Using $(get_sed_type) sed syntax"

	find "$BUILD_DIR/assets/workspace" -type f -print0 | while IFS= read -r -d '' file; do
		sed_inplace "s|{{IMAGE_TAG}}|$BUILD_VERSION|g" "$file"
	done

	echo "ðŸ” DEBUG: Template replacement completed"
	echo "ðŸ” DEBUG: Verifying replacements..."
	if grep -r "{{IMAGE_TAG}}" "$BUILD_DIR/assets/workspace" 2>/dev/null; then
		echo "âš ï¸  WARNING: Some {{IMAGE_TAG}} placeholders were not replaced!"
	else
		echo "ðŸ” DEBUG: All {{IMAGE_TAG}} placeholders successfully replaced"
	fi

	# Generate OS-specific docker-compose.override.yml for podman socket
	echo "Generating docker-compose.override.yml for host OS..."
	HOST_OS=$(detect_os)
	echo "ðŸ” DEBUG: Detected host OS: $HOST_OS"

	OVERRIDE_FILE="$BUILD_DIR/assets/workspace/.devcontainer/docker-compose.override.yml"

	if [ "$HOST_OS" = "macos" ]; then
		# macOS: Use UID 501 (default macOS user) - path is inside Podman VM
		SOCKET_PATH="/run/user/501/podman/podman.sock"
		echo "ðŸ” DEBUG: Using macOS socket path: $SOCKET_PATH"
	else
		# Linux: Use UID 1000 (default Linux user)
		SOCKET_PATH="/run/user/1000/podman/podman.sock"
		echo "ðŸ” DEBUG: Using Linux socket path: $SOCKET_PATH"
	fi

	cat > "$OVERRIDE_FILE" << EOF
# Auto-generated docker-compose.override.yml for $HOST_OS
# Generated by build.sh at $(date -u +"%Y-%m-%dT%H:%M:%SZ")
#
# This file mounts the Podman socket for container-in-container operations.
# Modify as needed for your system (e.g., different UID or Docker Desktop).

version: '3.8'

services:
  devcontainer:
    volumes:
      # Podman socket mount (auto-detected for $HOST_OS)
      - $SOCKET_PATH:/var/run/docker.sock:Z
EOF

	echo "âœ“ Generated docker-compose.override.yml with socket: $SOCKET_PATH"
else
	echo "ðŸ” DEBUG: $BUILD_DIR/assets/workspace does not exist, skipping template replacement"
fi

# Build the image from build folder
echo "Building image from build folder..."
echo "ðŸ” DEBUG: Running podman build with:"
echo "ðŸ” DEBUG:   Platform: $NATIVE_PLATFORM"
echo "ðŸ” DEBUG:   BUILD_DATE: $BUILD_DATE"
echo "ðŸ” DEBUG:   VCS_REF: $VCS_REF"
echo "ðŸ” DEBUG:   IMAGE_TAG: $BUILD_VERSION"
echo "ðŸ” DEBUG:   Tag: $REPO:$BUILD_VERSION"
echo "ðŸ” DEBUG:   Containerfile: $BUILD_DIR/Containerfile"
echo "ðŸ” DEBUG:   Build context: $BUILD_DIR"

if ! podman build --platform "$NATIVE_PLATFORM" \
	--build-arg BUILD_DATE="$BUILD_DATE" \
	--build-arg VCS_REF="$VCS_REF" \
	--build-arg IMAGE_TAG="$BUILD_VERSION" \
	-t "$REPO:$BUILD_VERSION" \
	-f "$BUILD_DIR/Containerfile" \
	"$BUILD_DIR"; then
	BUILD_EXIT_CODE=$?
	echo "âŒ Build failed"
	echo "ðŸ” DEBUG: Podman build command failed with exit code $BUILD_EXIT_CODE"
	exit 1
fi

echo "ðŸ” DEBUG: Podman build completed successfully"
echo "âœ“ Built local development image $REPO:$BUILD_VERSION ($NATIVE_PLATFORM)"
