# ===============================================================================
# DEVCONTAINER BASE RECIPES - DO NOT EDIT
# Managed by vigOS devcontainer. Customizations go in root justfile.
# ===============================================================================

set shell := ["bash", "-euo", "pipefail", "-c"]

# -------------------------------------------------------------------------------
# CODE QUALITY
# -------------------------------------------------------------------------------

# Run all linters
[group('quality')]
lint:
    uv run ruff check .

# Format code
[group('quality')]
format:
    uv run ruff format .

# Run pre-commit hooks on all files
[group('quality')]
precommit:
    uv run pre-commit run --all-files

# -------------------------------------------------------------------------------
# TESTING
# -------------------------------------------------------------------------------

# Run tests with pytest
[group('test')]
test-pytest *args:
    uv run pytest {{ args }}

# Run tests with coverage
[group('test')]
test-cov *args:
    uv run pytest --cov --cov-report=term-missing {{ args }}

# -------------------------------------------------------------------------------
# DEPENDENCIES
# -------------------------------------------------------------------------------

# Sync all dependencies (idempotent, fast if nothing changed)
[group('deps')]
sync:
    @if [ -f pyproject.toml ]; then uv sync --all-extras --no-install-project; fi

# Update all dependencies
[group('deps')]
update:
    uv lock --upgrade
    uv sync

# -------------------------------------------------------------------------------
# BUILD
# -------------------------------------------------------------------------------

# Clean build artifacts
[group('build')]
clean-artifacts:
    rm -rf .pytest_cache .ruff_cache .coverage htmlcov dist build *.egg-info
    find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true

# -------------------------------------------------------------------------------
# VERSION CHECK
# -------------------------------------------------------------------------------

# Check for devcontainer updates (verbose)
# Usage: just check [config|on|off|<duration>]
# Examples: just check, just check config, just check off, just check 7d
[group('info')]
check *args:
    #!/usr/bin/env bash
    SCRIPT_DIR="$(cd "$(dirname "{{justfile_directory()}}")/.devcontainer/scripts" && pwd)" || {
        echo "Error: Could not locate .devcontainer/scripts directory"
        exit 1
    }

    if [[ ! -f "$SCRIPT_DIR/version-check.sh" ]]; then
        echo "Error: version-check.sh not found at $SCRIPT_DIR"
        exit 1
    fi

    if [[ $# -eq 0 ]]; then
        # No args provided - run in verbose check mode
        "$SCRIPT_DIR/version-check.sh" check
    else
        # Pass all arguments through to the script
        "$SCRIPT_DIR/version-check.sh" "$@"
    fi

# Upgrade devcontainer to latest version (host-side only)
# This recipe MUST be run from a host terminal, not inside the container
[group('info')]
devcontainer-upgrade:
    #!/usr/bin/env bash
    # Detect if running inside a container
    if [[ -f "/.dockerenv" ]] || [[ -n "${container:-}" ]]; then
        echo ""
        echo "âŒ ERROR: This command must be run from a HOST terminal"
        echo ""
        echo "You are currently inside the devcontainer."
        echo "Open a new terminal on your host machine and run:"
        echo ""
        echo "    cd $(pwd)"
        echo "    just devcontainer-upgrade"
        echo ""
        echo "Or use the curl method:"
        echo ""
        echo "    curl -sSf https://vig-os.github.io/devcontainer/install.sh | sh -s -- --force ."
        echo ""
        exit 1
    fi

    # We're on the host - proceed with upgrade
    echo "ðŸš€ Upgrading devcontainer to latest version..."
    echo ""

    # Check if podman or docker is available
    if command -v podman &> /dev/null; then
        RUNTIME="podman"
    elif command -v docker &> /dev/null; then
        RUNTIME="docker"
    else
        echo "âŒ ERROR: Neither podman nor docker is installed"
        echo ""
        echo "Please install one of them first:"
        echo "  macOS:  brew install podman && podman machine init && podman machine start"
        echo "  Linux:  sudo apt install podman   # or equivalent for your distro"
        echo ""
        exit 1
    fi

    echo "âœ“ Using $RUNTIME"
    echo ""
    echo "Downloading and running install script..."
    curl -sSf https://vig-os.github.io/devcontainer/install.sh | sh -s -- --force .

# -------------------------------------------------------------------------------
# SIDECAR
# -------------------------------------------------------------------------------

# List available sidecar containers
[group('sidecar')]
sidecars:
    #!/usr/bin/env bash
    echo "Available sidecar containers:"
    echo ""
    # Get running sidecars (exclude devcontainer itself)
    # Construct podman format string using printf to avoid just interpolation
    FORMAT=$(printf '\x7b\x7b.Names\x7d\x7d')
    RUNNING=$(podman ps --format "$FORMAT" 2>/dev/null | grep -v "^devcontainer$" || true)
    if [ -n "$RUNNING" ]; then
        echo "$RUNNING" | while read -r name; do
            echo "  [OK] $name (running)"
        done
    else
        echo "  (no sidecars currently running)"
    fi
    echo ""
    echo "To use a sidecar: just sidecar <name> <recipe> [args...]"
    echo "Example: just sidecar postgres migrate"

# Execute a just recipe in a sidecar container
# Usage: just sidecar <container-name> <recipe> [args...]

# Example: just sidecar postgres migrate / just sidecar redis flush
[group('sidecar')]
sidecar name *args:
    #!/usr/bin/env bash
    # Construct podman format string using printf to avoid just interpolation
    FORMAT=$(printf '\x7b\x7b.Names\x7d\x7d')

    # Check if container exists (running or stopped)
    if ! podman ps -a --format "$FORMAT" 2>/dev/null | grep -q "^{{ name }}$"; then
        echo "[ERROR] Sidecar container '{{ name }}' not found"
        echo ""
        echo "Available sidecars:"
        RUNNING=$(podman ps --format "$FORMAT" 2>/dev/null | grep -v "^devcontainer$" || true)
        if [ -n "$RUNNING" ]; then
            echo "$RUNNING" | while read -r n; do
                echo "  - $n"
            done
        else
            echo "  (no sidecars found)"
        fi
        echo ""
        echo "Tip: Add sidecars to docker-compose.project.yaml or docker-compose.local.yaml"
        echo "Then run: just sidecars"
        exit 1
    fi

    # Check if container is running
    if ! podman ps --format "$FORMAT" 2>/dev/null | grep -q "^{{ name }}$"; then
        echo "[!]  Sidecar container '{{ name }}' exists but is not running"
        echo "Starting container..."
        podman start {{ name }} || {
            echo "[ERROR] Failed to start container '{{ name }}'"
            exit 1
        }
        # Wait a moment for container to be ready
        sleep 1
    fi

    # Execute the recipe in the sidecar
    podman exec {{ name }} just {{ args }}
